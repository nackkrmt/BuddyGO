<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Admin Pro - Auto Lock Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .is-locked { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 flex flex-col items-center">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl p-6 border border-slate-200 mb-6 tracking-tight relative overflow-hidden">
        <div id="lockBanner" class="hidden absolute top-0 left-0 w-full bg-amber-500 text-white text-[10px] font-bold py-1 text-center uppercase tracking-[0.2em] shadow-sm animate-pulse">
            Locked: รอบนี้ส่งผลครบถ้วนแล้ว
        </div>

        <h1 class="text-2xl font-bold text-center text-slate-800 mb-6 mt-2">จัดการการแข่งขัน</h1>
        
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <select id="divId" onchange="checkLockStatus()" class="border-2 rounded-xl p-3 bg-slate-50 outline-none focus:border-blue-500 transition cursor-pointer">
                    <option value="01">รุ่น 01</option><option value="02">รุ่น 02</option>
                    <option value="03" selected>รุ่น 03</option><option value="04">รุ่น 04</option>
                    <option value="05">รุ่น 05</option>
                </select>
                <select id="round" onchange="checkLockStatus()" class="border-2 rounded-xl p-3 bg-slate-50 outline-none focus:border-blue-500 transition cursor-pointer">
                    <option value="1">รอบ 1</option><option value="2">รอบ 2</option><option value="3">รอบ 3</option><option value="4">รอบ 4</option><option value="5">รอบ 5</option>
                </select>
            </div>
            
            <div id="mainActions" class="space-y-4 transition-all duration-500">
                <div class="flex gap-2">
                    <input type="number" id="tableNo" inputmode="numeric" pattern="[0-9]*" placeholder="เลขโต๊ะ" 
                           class="flex-1 border-2 rounded-xl p-3 bg-slate-50 text-center font-bold text-lg outline-none focus:border-blue-500 transition">
                    <button id="btnSearch" onclick="searchMatch()" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition disabled:bg-slate-300">ค้นหา</button>
                </div>
                
                <button id="btnPlayerList" onclick="fetchAllPlayers()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-medium flex justify-center items-center gap-2 hover:bg-black transition disabled:bg-slate-300">
                    ตารางเช็คชื่อ / Force Pairing
                </button>
            </div>
        </div>

        <div id="matchArea" class="hidden mt-6 pt-6 border-t border-dashed border-slate-200">
            <div class="bg-blue-50 p-5 rounded-2xl text-center mb-6 border border-blue-100 relative">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-[10px] px-3 py-0.5 rounded-full font-bold uppercase tracking-widest">Live Score</div>
                <div class="flex justify-between items-center mt-2">
                    <div class="flex-1 text-slate-900 font-bold text-base leading-tight" id="txtBlackDisp"></div>
                    <div class="px-4 text-4xl font-black text-blue-600 italic tracking-tighter" id="txtScore">?-?</div>
                    <div class="flex-1 text-blue-800 font-bold text-base leading-tight" id="txtWhiteDisp"></div>
                </div>
            </div>

            <p class="text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 italic">เลือกผู้ชนะ</p>
            <div id="winnerButtons" class="grid grid-cols-1 gap-3">
                <button id="btnWinB" onclick="submitResult('Black Win')" class="bg-white border-2 border-slate-800 text-slate-800 p-5 rounded-2xl font-bold text-lg shadow-sm hover:bg-slate-800 hover:text-white transition active:scale-95"></button>
                <button id="btnWinW" onclick="submitResult('White Win')" class="bg-white border-2 border-blue-600 text-blue-600 p-5 rounded-2xl font-bold text-lg shadow-sm hover:bg-blue-600 hover:text-white transition active:scale-95"></button>
            </div>
        </div>

        <hr class="my-6 border-slate-100">

        <div class="space-y-3">
            <button onclick="fetchStatusGrid()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold border border-emerald-100 flex justify-center items-center gap-2 hover:bg-emerald-100 transition">
                <div class="w-3 h-3 bg-emerald-500 rounded-sm"></div>
                ตรวจสอบสถานะโต๊ะทั้งหมด
            </button>
            <div id="gridArea" class="hidden">
                <div id="statusGrid" class="grid grid-cols-5 sm:grid-cols-8 gap-2 bg-slate-50 p-3 rounded-2xl border border-slate-100"></div>
                <div id="gridSummary" class="text-center text-[10px] font-bold text-slate-500 mt-3 uppercase tracking-widest"></div>
            </div>
        </div>
    </div>

    <div id="playerModal" class="hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0">
                <h3 class="text-xl font-bold text-slate-800">รายชื่อและผลการแข่งขัน</h3>
                <button onclick="toggleModal('playerModal')" class="text-4xl text-slate-300 hover:text-slate-500">&times;</button>
            </div>
            <div class="overflow-auto bg-white">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 text-[10px] uppercase font-bold text-slate-500 sticky top-0">
                        <tr>
                            <th class="p-4 text-center border-r">โต๊ะ</th>
                            <th class="p-4">นักกีฬา</th>
                            <th class="p-4 text-center">มา?</th>
                            <th class="p-4 text-center border-l">ผู้ชนะ</th>
                            <th class="p-4 text-center border-l">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="playerTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="forceModal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-5 text-slate-800">Force Pairing โต๊ะ <span id="forceTableLabel" class="text-blue-600"></span></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Black Player</label>
                    <select id="forceBlackSelect" class="w-full border rounded-lg p-2 bg-slate-50 mb-1 outline-none"></select>
                    <input type="text" id="forceBlackInput" placeholder="หรือพิมพ์ชื่อใหม่" class="w-full border rounded-lg p-2 text-sm outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">White Player</label>
                    <select id="forceWhiteSelect" class="w-full border rounded-lg p-2 bg-slate-50 mb-1 outline-none"></select>
                    <input type="text" id="forceWhiteInput" placeholder="หรือพิมพ์ชื่อใหม่" class="w-full border rounded-lg p-2 text-sm outline-none">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="saveForce()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold active:scale-95 transition">บันทึก</button>
                    <button onclick="toggleModal('forceModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold active:scale-95 transition">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwfJ9PngjgJ-EqCE6hipjhYjftPsHuuQdz9dTv0rnXMlJhTAGUZKPZIzJxfFZMeJOG/exec";
        let isLocked = false;
        let allNamesList = [];
        let currentForceTable = null;

        // ฟังก์ชันเช็คสถานะการล็อค
        async function checkLockStatus() {
            const div = document.getElementById('divId').value;
            const rnd = document.getElementById('round').value;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&round=${rnd}`);
                const data = await res.json();
                if(data.status === "success") {
                    const total = data.players.length;
                    const sent = data.players.filter(p => p.result !== "?-?").length;
                    
                    isLocked = (total > 0 && sent === total);
                    
                    const banner = document.getElementById('lockBanner');
                    const mainActions = document.getElementById('mainActions');
                    const winnerBtns = document.getElementById('winnerButtons');

                    if(isLocked) {
                        banner.classList.remove('hidden');
                        mainActions.classList.add('is-locked');
                        winnerBtns.classList.add('is-locked');
                        document.getElementById('btnSearch').disabled = true;
                        document.getElementById('btnPlayerList').disabled = true;
                    } else {
                        banner.classList.add('hidden');
                        mainActions.classList.remove('is-locked');
                        winnerBtns.classList.remove('is-locked');
                        document.getElementById('btnSearch').disabled = false;
                        document.getElementById('btnPlayerList').disabled = false;
                    }
                }
            } catch(e) { console.error("Lock check failed", e); }
        }

        async function searchMatch() {
            if(isLocked) return alert("รอบนี้ถูกล็อคแล้ว เนื่องจากส่งผลครบทุกคู่");
            const div = document.getElementById('divId').value;
            const rnd = document.getElementById('round').value;
            const tbl = document.getElementById('tableNo').value;
            if(!tbl) return alert("ระบุเลขโต๊ะ");
            const res = await fetch(`${SCRIPT_URL}?divId=${div}&round=${rnd}&table=${tbl}`);
            const data = await res.json();
            if(data.found) {
                document.getElementById('txtBlackDisp').innerText = data.black;
                document.getElementById('txtWhiteDisp').innerText = data.white;
                document.getElementById('txtScore').innerText = data.result;
                document.getElementById('btnWinB').innerText = data.black;
                document.getElementById('btnWinW').innerText = data.white;
                document.getElementById('matchArea').classList.remove('hidden');
            } else alert("ไม่พบข้อมูล");
        }

        async function submitResult(winner) {
            if(isLocked) return alert("ไม่สามารถบันทึกได้ รอบนี้ถูกล็อคแล้ว");
            if(!confirm(`ยืนยันการบันทึกผล?`)) return;
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ divId: document.getElementById('divId').value, round: document.getElementById('round').value, table: document.getElementById('tableNo').value, winner })
            });
            if((await res.json()).status === "success") { alert("สำเร็จ!"); location.reload(); }
        }

        async function fetchStatusGrid() {
            const div = document.getElementById('divId').value;
            const rnd = document.getElementById('round').value;
            document.getElementById('gridArea').classList.remove('hidden');
            document.getElementById('statusGrid').innerHTML = "Loading...";
            const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&round=${rnd}`);
            const data = await res.json();
            if(data.status === "success") {
                let sent = 0;
                document.getElementById('statusGrid').innerHTML = data.players.map(p => {
                    const ok = p.result !== "?-?";
                    if(ok) sent++;
                    return `<div class="aspect-square flex items-center justify-center rounded-lg text-[10px] font-bold shadow-sm ${ok ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}">${p.table}</div>`;
                }).join('');
                document.getElementById('gridSummary').innerText = `ส่งแล้ว ${sent} / ${data.players.length} โต๊ะ`;
            }
        }

        async function fetchAllPlayers() {
            const div = document.getElementById('divId').value;
            const rnd = document.getElementById('round').value;
            toggleModal('playerModal');
            const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&round=${rnd}`);
            const data = await res.json();
            allNamesList = data.allNames;
            document.getElementById('playerTableBody').innerHTML = data.players.map(p => {
                let winName = "-", winCls = "text-slate-200";
                if(p.result === "1-0") { winName = p.black; winCls = "text-emerald-600 font-bold"; }
                else if(p.result === "0-1") { winName = p.white; winCls = "text-emerald-600 font-bold"; }
                return `
                    <tr class="border-b border-slate-100">
                        <td rowspan="2" class="p-4 font-bold text-slate-400 border-r w-16 text-center bg-slate-50/30">${p.table}</td>
                        <td class="p-4 font-semibold text-slate-700 text-base">${p.black}</td>
                        <td class="p-4 text-center w-14 border-l"><input type="checkbox" class="w-6 h-6 accent-slate-800"></td>
                        <td rowspan="2" class="p-4 text-center border-l w-32"><div class="${winCls} text-[11px] leading-tight">${winName}</div></td>
                        <td rowspan="2" class="p-4 text-center border-l w-20">
                            <button onclick="openForce('${p.table}', '${p.black}', '${p.white}')" 
                                    class="${isLocked ? 'hidden' : ''} bg-indigo-50 text-indigo-600 px-3 py-2 rounded-xl text-[10px] font-bold uppercase transition">Force</button>
                        </td>
                    </tr>
                    <tr class="border-b border-slate-200"><td class="p-4 font-semibold text-blue-700 text-base bg-white">${p.white}</td><td class="p-4 text-center w-14 border-l bg-white"><input type="checkbox" class="w-6 h-6 accent-blue-600"></td></tr>
                `;
            }).join('');
        }

        function openForce(t, b, w) {
            if(isLocked) return;
            currentForceTable = t;
            document.getElementById('forceTableLabel').innerText = t;
            const opts = `<option value="">-- เลือกชื่อ --</option>` + allNamesList.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('forceBlackSelect').innerHTML = opts;
            document.getElementById('forceWhiteSelect').innerHTML = opts;
            toggleModal('forceModal');
        }

        async function saveForce() {
            if(isLocked) return;
            const newB = document.getElementById('forceBlackInput').value || document.getElementById('forceBlackSelect').value || "ไม่มีผู้เข้าแข่งขัน";
            const newW = document.getElementById('forceWhiteInput').value || document.getElementById('forceWhiteSelect').value || "ไม่มีผู้เข้าแข่งขัน";
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'force', divId: document.getElementById('divId').value, round: document.getElementById('round').value, table: currentForceTable, newBlack: newB, newWhite: newW })
            });
            if((await res.json()).status === "success") { alert("สำเร็จ!"); location.reload(); }
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        
        // รันครั้งแรกตอนโหลดหน้า
        window.onload = checkLockStatus;
    </script>
</body>
</html>
