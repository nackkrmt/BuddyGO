<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - BuddyGO Competition Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .is-locked-visual { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        /* Animation Classes */
        #offlineBar { position: fixed; top: 0; left: 0; width: 100%; z-index: 100; text-align: center; font-size: 12px; font-weight: bold; padding: 8px; transform: translateY(-100%); transition: transform 0.3s ease-in-out; }
        .is-offline { transform: translateY(0) !important; background: #ef4444; color: white; }
        .is-online-back { transform: translateY(0) !important; background: #10b981; color: white; }
        
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 pt-12 flex flex-col items-center">

    <div id="offlineBar">‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</div>

    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl p-6 border border-slate-200 relative overflow-hidden">
        
        <div id="lockBanner" class="hidden absolute top-0 left-0 w-full bg-amber-500 text-white text-[10px] font-bold py-1 text-center uppercase tracking-widest z-10 animate-pulse">
            Locked: ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        </div>
        
        <h1 class="text-2xl font-bold text-center text-slate-800 mb-2 mt-2 uppercase tracking-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
        
        <div class="flex flex-col items-center gap-2 mb-6">
            <div id="roundLabel" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <select id="roundPicker" onchange="autoLoadData(this.value)" class="bg-blue-50 text-blue-600 font-bold text-sm py-1 px-4 rounded-full border border-blue-100 outline-none cursor-pointer hover:bg-blue-100 transition shadow-sm">
                <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
            </select>
        </div>

        <div id="mainContent" class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô (Division)</label>
                <select id="divId" onchange="autoLoadData()" class="w-full border-2 rounded-xl p-3 bg-slate-50 outline-none focus:border-blue-500 mt-1 cursor-pointer text-sm font-bold shadow-sm transition"></select>
            </div>
            
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="number" id="tableNo" inputmode="numeric" pattern="[0-9]*" placeholder="‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞" class="flex-1 border-2 rounded-xl p-3 bg-slate-50 text-center font-bold text-lg outline-none focus:border-blue-500 transition shadow-sm">
                    <button onclick="searchMatch()" class="bg-blue-600 text-white px-6 rounded-xl font-bold active:scale-95 transition shadow-sm hover:bg-blue-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>

                <div id="actionButtonsArea">
                    <button id="btnCheckin" onclick="fetchAllPlayers()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold text-xs shadow-sm hover:bg-slate-900 transition flex justify-center items-center gap-2">
                        <span>üìã</span> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ / Force Pairing
                    </button>
                    <button id="btnHistory" onclick="fetchHistoryResults()" class="hidden w-full bg-amber-500 text-white py-3 rounded-xl font-semibold text-xs shadow-sm hover:bg-amber-600 transition flex justify-center items-center gap-2">
                        <span>üìä</span> ‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
                    </button>
                </div>
            </div>

            <div id="matchArea" class="hidden mt-6 pt-6 border-t border-dashed border-slate-200 animate-in fade-in duration-300">
                <div class="bg-blue-50 p-5 rounded-2xl text-center mb-6 border border-blue-100 relative overflow-hidden">
                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex-1 text-slate-900 font-bold text-base leading-tight break-words" id="txtBlackDisp"></div>
                        <div class="px-2 text-4xl font-black text-blue-600 italic tracking-tighter" id="txtScore">?-?</div>
                        <div class="flex-1 text-blue-800 font-bold text-base leading-tight break-words" id="txtWhiteDisp"></div>
                    </div>
                </div>
                
                <p class="text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 italic">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</p>
                <div id="winnerButtons" class="grid grid-cols-1 gap-3">
                    <button id="btnWinB" onclick="submitResult('Black Win')" class="bg-white border-2 border-slate-800 text-slate-800 p-4 rounded-2xl font-bold text-lg hover:bg-slate-800 hover:text-white transition active:scale-95 shadow-sm"></button>
                    <button id="btnWinW" onclick="submitResult('White Win')" class="bg-white border-2 border-blue-600 text-blue-600 p-4 rounded-2xl font-bold text-lg hover:bg-blue-600 hover:text-white transition active:scale-95 shadow-sm"></button>
                </div>
            </div>

            <hr class="my-6 border-slate-100">
            
            <button onclick="fetchStatusGrid()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold border border-emerald-100 text-sm hover:bg-emerald-100 transition flex justify-center items-center gap-2">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ú‡∏•
            </button>
            <div id="gridArea" class="hidden mt-4 animate-in slide-in-from-top-2">
                <div id="statusGrid" class="grid grid-cols-5 sm:grid-cols-8 gap-2 bg-slate-50 p-3 rounded-2xl border border-slate-100"></div>
                <div id="gridSummary" class="text-center text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-widest"></div>
            </div>
        </div>
    </div>

    <div id="playerModal" class="hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center modal backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 leading-tight">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide" id="modalSubTitle"></p>
                </div>
                <button onclick="toggleModal('playerModal')" class="text-3xl text-slate-300 hover:text-slate-500 leading-none transition">&times;</button>
            </div>
            <div class="overflow-auto bg-white flex-1">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-500 sticky top-0 shadow-sm z-10">
                        <tr><th class="p-3 text-center border-r w-12">‡πÇ‡∏ï‡πä‡∏∞</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠ (‡∏î‡∏≥ / ‡∏Ç‡∏≤‡∏ß)</th><th class="p-3 text-center w-10">‡πÄ‡∏ä‡πá‡∏Ñ</th><th class="p-3 text-center border-l w-20">Force Pairing</th></tr>
                    </thead>
                    <tbody id="playerTableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyModal" class="hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center modal backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 leading-tight">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide" id="historyModalSub"></p>
                </div>
                <button onclick="toggleModal('historyModal')" class="text-3xl text-slate-300 hover:text-slate-500 leading-none transition">&times;</button>
            </div>
            <div class="overflow-auto bg-white flex-1">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-500 sticky top-0 border-b z-10">
                        <tr><th class="p-3 text-center w-12">‡πÇ‡∏ï‡πä‡∏∞</th><th class="p-3">‡∏î‡∏≥</th><th class="p-3 text-center w-14 bg-slate-100">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</th><th class="p-3 text-right">‡∏Ç‡∏≤‡∏ß</th></tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-100 text-xs"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="forceModal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 modal backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-5 text-slate-800">Force Pairing ‡πÇ‡∏ï‡πä‡∏∞ <span id="forceTableLabel" class="text-blue-600 font-black"></span></h3>
            <div class="space-y-4">
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Black</label>
                <select id="forceBlackSelect" class="w-full border rounded-lg p-2 bg-slate-50 font-bold outline-none text-sm mb-1"></select>
                <input type="text" id="forceBlackInput" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà..." class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">White</label>
                <select id="forceWhiteSelect" class="w-full border rounded-lg p-2 bg-slate-50 font-bold outline-none text-sm mb-1"></select>
                <input type="text" id="forceWhiteInput" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà..." class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="forceRemark" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å..." class="w-full border rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 h-16"></textarea></div>
                <div class="flex gap-3 pt-2"><button onclick="saveForce()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-100 active:scale-95 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="toggleModal('forceModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold active:scale-95 transition hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  CONFIG: ‡πÉ‡∏™‡πà URL Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwfJ9PngjgJ-EqCE6hipjhYjftPsHuuQdz9dTv0rnXMlJhTAGUZKPZIzJxfFZMeJOG/exec";
        
        let currentRound = "", allNamesList = [], isLocked = false, isHistoryMode = false, currentForceTable = null;

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        function updateNetworkStatus() {
            const bar = document.getElementById('offlineBar');
            if (navigator.onLine) {
                bar.innerText = "‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß"; bar.classList.replace('is-offline', 'is-online-back');
                document.body.classList.remove('is-locked-visual'); 
                setTimeout(() => bar.classList.remove('is-online-back'), 2500);
            } else {
                bar.innerText = "‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï (‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏ú‡∏•)"; bar.classList.add('is-offline');
                document.body.classList.add('is-locked-visual');
            }
        }

        async function loadDivisions() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getDivisions`);
                const data = await res.json();
                if (data.status === "success") {
                    document.getElementById('divId').innerHTML = data.divisions.map(div => `<option value="${div.id}">${div.name}</option>`).join('');
                    autoLoadData();
                }
            } catch (e) { console.error(e); }
        }

        async function autoLoadData(targetRound = "") {
            const div = document.getElementById('divId').value;
            if(!div) return;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&targetRound=${targetRound}`);
                const data = await res.json();
                if(data.status === "success") {
                    currentRound = data.round;
                    allNamesList = data.allNames;
                    isHistoryMode = (currentRound != data.allRounds[0]);
                    
                    // 1. Update Dropdown
                    document.getElementById('roundPicker').innerHTML = data.allRounds.map(r => `<option value="${r}" ${r == currentRound ? 'selected' : ''}>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${r}</option>`).join('');
                    document.getElementById('roundLabel').innerText = isHistoryMode ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á" : "‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô";
                    document.getElementById('roundPicker').className = isHistoryMode 
                        ? "bg-amber-100 text-amber-700 font-bold text-sm py-1 px-4 rounded-full border border-amber-200 outline-none cursor-pointer shadow-sm" 
                        : "bg-blue-50 text-blue-600 font-bold text-sm py-1 px-4 rounded-full border border-blue-100 outline-none cursor-pointer shadow-sm";
                    
                    // 2. Button Logic (SWAP BUTTONS)
                    if (isHistoryMode) {
                        document.getElementById('btnCheckin').classList.add('hidden');
                        document.getElementById('btnHistory').classList.remove('hidden');
                    } else {
                        document.getElementById('btnCheckin').classList.remove('hidden');
                        document.getElementById('btnHistory').classList.add('hidden');
                    }

                    // 3. Lock Status
                    const total = data.players.length, sent = data.players.filter(p => p.result !== "?-?").length;
                    isLocked = (total > 0 && sent === total);
                    document.getElementById('lockBanner').classList.toggle('hidden', !isLocked);
                    document.getElementById('modalSubTitle').innerText = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${currentRound}`;
                    document.getElementById('historyModalSub').innerText = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${currentRound}`;
                }
            } catch (e) { console.error(e); }
        }

        async function searchMatch() {
            const div = document.getElementById('divId').value, tbl = document.getElementById('tableNo').value;
            if(!tbl) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞");
            const res = await fetch(`${SCRIPT_URL}?divId=${div}&table=${tbl}&targetRound=${currentRound}`);
            const data = await res.json();
            if(data.found) {
                document.getElementById('txtBlackDisp').innerText = data.black;
                document.getElementById('txtWhiteDisp').innerText = data.white;
                document.getElementById('txtScore').innerText = data.result;
                document.getElementById('btnWinB').innerText = data.black;
                document.getElementById('btnWinW').innerText = data.white;
                
                // Visual Lock if History or All Sent
                document.getElementById('winnerButtons').className = (isHistoryMode || isLocked) ? "grid grid-cols-1 gap-3 is-locked-visual" : "grid grid-cols-1 gap-3";
                document.getElementById('matchArea').classList.remove('hidden');
            } else alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }

        async function submitResult(winner) {
            if(isHistoryMode || isLocked) return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ");
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•?`)) return;
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'result', divId: document.getElementById('divId').value, round: currentRound, table: document.getElementById('tableNo').value, winner: winner })
            });
            if((await res.json()).status === "success") { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); location.reload(); }
        }

        async function toggleCheckin(table, side, checked) {
            if(isHistoryMode) return;
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'checkin', divId: document.getElementById('divId').value, round: currentRound, table: table, side: side, checked: checked })
            });
        }

        async function fetchAllPlayers() {
            const div = document.getElementById('divId').value;
            toggleModal('playerModal');
            document.getElementById('playerTableBody').innerHTML = "<tr><td colspan='4' class='p-12 text-center text-slate-400 italic'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";
            const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&targetRound=${currentRound}`);
            const data = await res.json();
            document.getElementById('playerTableBody').innerHTML = data.players.map(p => `
                <tr class="border-b hover:bg-slate-50 transition">
                    <td rowspan="2" class="p-3 font-bold text-slate-400 border-r w-12 text-center bg-slate-50/50">${p.table}</td>
                    <td class="p-3 font-semibold text-slate-700 leading-tight">${p.black}</td>
                    <td class="p-3 text-center border-l"><input type="checkbox" onchange="toggleCheckin('${p.table}', 'B', this.checked)" ${p.checkB ? 'checked' : ''} ${isHistoryMode ? 'disabled' : ''} class="w-5 h-5 accent-slate-800 cursor-pointer"></td>
                    <td rowspan="2" class="p-3 text-center border-l w-20 bg-white">
                        <button onclick="openForce('${p.table}', '${p.black}', '${p.white}')" class="${isLocked || isHistoryMode ? 'hidden' : ''} bg-indigo-50 text-indigo-600 px-2 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-indigo-100 transition">Force</button>
                    </td>
                </tr>
                <tr class="border-b hover:bg-slate-50 transition"><td class="p-3 font-semibold text-blue-700 leading-tight bg-white">${p.white}</td><td class="p-3 text-center border-l bg-white"><input type="checkbox" onchange="toggleCheckin('${p.table}', 'W', this.checked)" ${p.checkW ? 'checked' : ''} ${isHistoryMode ? 'disabled' : ''} class="w-5 h-5 accent-blue-600 cursor-pointer"></td></tr>
            `).join('');
        }

        async function fetchHistoryResults() {
            const div = document.getElementById('divId').value;
            toggleModal('historyModal');
            document.getElementById('historyTableBody').innerHTML = "<tr><td colspan='4' class='p-12 text-center text-slate-400 italic'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•...</td></tr>";
            const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&targetRound=${currentRound}`);
            const data = await res.json();
            document.getElementById('historyTableBody').innerHTML = data.players.map(p => `
                <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                    <td class="p-3 text-center font-bold text-slate-300 border-r">${p.table}</td>
                    <td class="p-3 font-semibold text-slate-600 leading-tight">${p.black}</td>
                    <td class="p-3 text-center font-black ${p.result !== "?-?" ? 'text-blue-600 bg-blue-50/30' : 'text-slate-300 bg-slate-50'}">${p.result}</td>
                    <td class="p-3 text-right font-semibold text-slate-600 leading-tight">${p.white}</td>
                </tr>
            `).join('');
        }

        async function fetchStatusGrid() {
            const div = document.getElementById('divId').value;
            document.getElementById('gridArea').classList.remove('hidden');
            document.getElementById('statusGrid').innerHTML = "<div class='col-span-full py-4 text-center text-xs text-slate-400 italic'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>";
            const res = await fetch(`${SCRIPT_URL}?action=list&divId=${div}&targetRound=${currentRound}`);
            const data = await res.json();
            let sent = 0;
            const gridHTML = data.players.map(p => {
                if(p.result !== "?-?") sent++;
                return `<div class="aspect-square flex items-center justify-center rounded-lg text-[10px] font-bold shadow-sm transition hover:scale-105 ${p.result !== "?-?" ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}">${p.table}</div>`;
            }).join('');
            document.getElementById('statusGrid').innerHTML = gridHTML;
            document.getElementById('gridSummary').innerText = `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${sent} / ${data.players.length} ‡∏Ñ‡∏π‡πà`;
        }

        function openForce(t, b, w) {
            currentForceTable = t;
            const opts = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° --</option>` + allNamesList.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('forceBlackSelect').innerHTML = opts; 
            document.getElementById('forceWhiteSelect').innerHTML = opts;
            document.getElementById('forceBlackSelect').value = allNamesList.includes(b) ? b : "";
            document.getElementById('forceWhiteSelect').value = allNamesList.includes(w) ? w : "";
            document.getElementById('forceBlackInput').value = "";
            document.getElementById('forceWhiteInput').value = "";
            document.getElementById('forceRemark').value = "";
            document.getElementById('forceTableLabel').innerText = t;
            toggleModal('forceModal');
        }

        async function saveForce() {
            const b = document.getElementById('forceBlackInput').value || document.getElementById('forceBlackSelect').value;
            const w = document.getElementById('forceWhiteInput').value || document.getElementById('forceWhiteSelect').value;
            if(!b || !w) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á");
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Force Pairing ‡πÇ‡∏ï‡πä‡∏∞ ${currentForceTable}?\n‡∏î‡∏≥: ${b}\n‡∏Ç‡∏≤‡∏ß: ${w}`)) return;

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'force', divId: document.getElementById('divId').value, round: currentRound, table: currentForceTable, newBlack: b, newWhite: w, remark: document.getElementById('forceRemark').value })
            });
            if((await res.json()).status === "success") { alert("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); location.reload(); }
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        window.onload = () => { loadDivisions(); updateNetworkStatus(); };
    </script>
</body>
</html>

